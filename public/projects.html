<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®ç®¡ç† - ç®¡é“é˜²è…å±‚å‰¥ç¦»æ§åˆ¶ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/animations.css">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <div class="page-header">
                <h1>ğŸ“ é¡¹ç›®ç®¡ç†</h1>
                <div class="header-actions">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="form-input" id="searchInput" placeholder="æœç´¢é¡¹ç›®..." oninput="debouncedSearch()">
                    </div>
                    <button class="btn btn-primary" onclick="Utils.showModal('projectModal')">+ æ–°å»ºé¡¹ç›®</button>
                </div>
            </div>
            <div class="page-body">
                <div class="card animate-fade-in">
                    <div style="overflow-x:auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>é¡¹ç›®åç§°</th>
                                    <th>ç®¡é“ç›´å¾„</th>
                                    <th>é˜²è…å±‚å®½åº¦</th>
                                    <th>æ¡å¸¦æ•°</th>
                                    <th>é¢„ä¼°æ‹‰åŠ›</th>
                                    <th>ä½ç½®</th>
                                    <th>çŠ¶æ€</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="projectsBody">
                                <tr><td colspan="10" class="text-center text-dim p-3">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="pagination"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal-overlay" id="projectModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">æ–°å»ºé¡¹ç›®</h3>
                <button class="modal-close" onclick="Utils.hideModal('projectModal')">âœ•</button>
            </div>
            <form id="projectForm" onsubmit="return saveProject(event)">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label class="form-label">é¡¹ç›®åç§° *</label>
                    <input type="text" class="form-input" id="pName" required placeholder="ä¾‹: XXç®¡çº¿é˜²è…å±‚å‰¥ç¦»è¯•éªŒ">
                </div>
                <div class="form-group">
                    <label class="form-label">é¡¹ç›®æè¿°</label>
                    <textarea class="form-textarea" id="pDesc" rows="2" placeholder="é¡¹ç›®æè¿°ä¿¡æ¯"></textarea>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">ç®¡é“ç›´å¾„ (mm)</label>
                        <input type="number" class="form-input" id="pDiameter" value="1000" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é˜²è…å±‚å®½åº¦ (mm)</label>
                        <input type="number" class="form-input" id="pLayerWidth" value="600" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é˜²è…å±‚åšåº¦ (mm)</label>
                        <input type="number" class="form-input" id="pLayerThickness" value="1.0" step="0.0001">
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">æ¡å¸¦æ•°</label>
                        <input type="number" class="form-input" id="pStripCount" value="30">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¡å¸¦å®½åº¦ (mm)</label>
                        <input type="number" class="form-input" id="pStripWidth" value="20" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é¢„ä¼°æ‹‰åŠ› (N)</label>
                        <input type="number" class="form-input" id="pForce" value="30000" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ä½ç½®</label>
                    <input type="text" class="form-input" id="pLocation" placeholder="ç®¡é“ä½ç½®ä¿¡æ¯">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="Utils.hideModal('projectModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/nav.js"></script>
    <script>
        if (!Auth.requireAuth()) throw new Error('Not authenticated');
        Nav.init();

        let currentPage = 1;
        const debouncedSearch = Utils.debounce(() => { currentPage = 1; loadProjects(); }, 300);

        async function loadProjects() {
            const search = document.getElementById('searchInput').value.trim();
            try {
                const params = `?page=${currentPage}&per_page=15&search=${encodeURIComponent(search)}`;
                const res = await API.get('/projects' + params);
                renderProjects(res.projects || [], res.total || 0, res.page, res.per_page);
            } catch (e) {
                Utils.showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error');
            }
        }

        function renderProjects(projects, total, page, perPage) {
            const tbody = document.getElementById('projectsBody');
            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-dim p-3">æš‚æ— é¡¹ç›®æ•°æ®</td></tr>';
                return;
            }
            tbody.innerHTML = projects.map(p => `
                <tr class="animate-fade-in">
                    <td class="text-mono">${p.id}</td>
                    <td><strong>${Utils.escapeHtml(p.name)}</strong></td>
                    <td class="text-mono">${p.pipe_diameter} mm</td>
                    <td class="text-mono">${p.layer_width} mm</td>
                    <td class="text-mono">${p.strip_count}</td>
                    <td class="text-mono">${p.estimated_force} N</td>
                    <td>${Utils.escapeHtml(p.location || '-')}</td>
                    <td>${Utils.statusBadge(p.status)}</td>
                    <td class="text-dim">${Utils.formatDateShort(p.created_at)}</td>
                    <td>
                        <button class="btn btn-ghost btn-sm" onclick="editProject(${p.id})">ç¼–è¾‘</button>
                        <button class="btn btn-ghost btn-sm text-danger" onclick="deleteProject(${p.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');

            renderPagination(total, page, perPage);
        }

        function renderPagination(total, page, perPage) {
            const pages = Math.ceil(total / perPage);
            const container = document.getElementById('pagination');
            if (pages <= 1) { container.innerHTML = ''; return; }
            let html = `<button ${page <= 1 ? 'disabled' : ''} onclick="goPage(${page-1})">â€¹</button>`;
            for (let i = 1; i <= pages; i++) {
                html += `<button class="${i === page ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
            }
            html += `<button ${page >= pages ? 'disabled' : ''} onclick="goPage(${page+1})">â€º</button>`;
            container.innerHTML = html;
        }

        function goPage(p) { currentPage = p; loadProjects(); }

        async function saveProject(e) {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('pName').value.trim(),
                description: document.getElementById('pDesc').value.trim(),
                pipe_diameter: parseFloat(document.getElementById('pDiameter').value),
                layer_width: parseFloat(document.getElementById('pLayerWidth').value),
                layer_thickness: parseFloat(document.getElementById('pLayerThickness').value),
                strip_count: parseInt(document.getElementById('pStripCount').value),
                strip_width: parseFloat(document.getElementById('pStripWidth').value),
                estimated_force: parseFloat(document.getElementById('pForce').value),
                location: document.getElementById('pLocation').value.trim()
            };
            try {
                if (editId) {
                    await API.put(`/project_detail?id=${editId}`, data);
                    Utils.showToast('é¡¹ç›®å·²æ›´æ–°', 'success');
                } else {
                    await API.post('/projects', data);
                    Utils.showToast('é¡¹ç›®å·²åˆ›å»º', 'success');
                }
                Utils.hideModal('projectModal');
                loadProjects();
            } catch (e) {
                Utils.showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function editProject(id) {
            try {
                const res = await API.get(`/project_detail?id=${id}`);
                const p = res.project;
                document.getElementById('editId').value = p.id;
                document.getElementById('modalTitle').textContent = 'ç¼–è¾‘é¡¹ç›®';
                document.getElementById('pName').value = p.name;
                document.getElementById('pDesc').value = p.description || '';
                document.getElementById('pDiameter').value = p.pipe_diameter;
                document.getElementById('pLayerWidth').value = p.layer_width;
                document.getElementById('pLayerThickness').value = p.layer_thickness;
                document.getElementById('pStripCount').value = p.strip_count;
                document.getElementById('pStripWidth').value = p.strip_width;
                document.getElementById('pForce').value = p.estimated_force;
                document.getElementById('pLocation').value = p.location || '';
                Utils.showModal('projectModal');
            } catch (e) {
                Utils.showToast('åŠ è½½é¡¹ç›®å¤±è´¥', 'error');
            }
        }

        async function deleteProject(id) {
            if (!Utils.confirm('ç¡®å®šè¦åˆ é™¤æ­¤é¡¹ç›®åŠå…¶æ‰€æœ‰è¯•éªŒæ•°æ®ï¼Ÿ')) return;
            try {
                await API.delete(`/project_detail?id=${id}`);
                Utils.showToast('é¡¹ç›®å·²åˆ é™¤', 'success');
                loadProjects();
            } catch (e) {
                Utils.showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }

        // Reset modal on open new
        document.querySelector('[onclick="Utils.showModal(\'projectModal\')"]').addEventListener('click', () => {
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').textContent = 'æ–°å»ºé¡¹ç›®';
            document.getElementById('projectForm').reset();
            document.getElementById('pDiameter').value = 1000;
            document.getElementById('pLayerWidth').value = 600;
            document.getElementById('pLayerThickness').value = 1.0;
            document.getElementById('pStripCount').value = 30;
            document.getElementById('pStripWidth').value = 20;
            document.getElementById('pForce').value = 30000;
        });

        loadProjects();
    </script>
</body>
</html>
