<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯•éªŒæ§åˆ¶ - ç®¡é“é˜²è…å±‚å‰¥ç¦»æ§åˆ¶ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/animations.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <div class="page-header">
                <h1>ğŸ› è¯•éªŒæ§åˆ¶é¢æ¿</h1>
                <div class="header-actions">
                    <span id="testStatus" class="badge badge-pending">æœªå¯åŠ¨</span>
                </div>
            </div>
            <div class="page-body">
                <!-- Control Section -->
                <div class="grid grid-2 mb-2">
                    <!-- Left: Config -->
                    <div class="card animate-fade-in-up">
                        <div class="card-header">
                            <div class="card-title"><span class="icon">âš™</span> è¯•éªŒé…ç½®</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é€‰æ‹©é¡¹ç›®</label>
                            <select class="form-select" id="projectSelect">
                                <option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é€‰æ‹©/åˆ›å»ºè¯•éªŒ</label>
                            <select class="form-select" id="testSelect">
                                <option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">è¯•éªŒç¼–å·</label>
                                <input type="text" class="form-input" id="testNumber" placeholder="ä¾‹: TEST-2026-001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ“ä½œå‘˜</label>
                                <input type="text" class="form-input" id="operator" placeholder="æ“ä½œå‘˜å§“å">
                            </div>
                        </div>
                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="form-label">ç¯å¢ƒæ¸©åº¦ (Â°C)</label>
                                <input type="number" class="form-input" id="ambientTemp" placeholder="25" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç®¡é“æ¸©åº¦ (Â°C)</label>
                                <input type="number" class="form-input" id="pipeTemp" placeholder="25" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ¹¿åº¦ (%)</label>
                                <input type="number" class="form-input" id="humidity" placeholder="60" step="0.1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-textarea" id="testNotes" rows="2" placeholder="è¯•éªŒå¤‡æ³¨ä¿¡æ¯"></textarea>
                        </div>
                        <button class="btn btn-secondary" onclick="createTest()">åˆ›å»ºæ–°è¯•éªŒ</button>
                    </div>

                    <!-- Right: Controls -->
                    <div class="card animate-fade-in-up stagger-2">
                        <div class="card-header">
                            <div class="card-title"><span class="icon">â–¶</span> æ“ä½œæ§åˆ¶</div>
                        </div>
                        <div class="control-buttons mb-3">
                            <button class="btn btn-success btn-lg" id="btnStart" onclick="controlTest('start')">
                                â–¶ å¯åŠ¨è¯•éªŒ
                            </button>
                            <button class="btn btn-warning btn-lg" id="btnStop" onclick="controlTest('stop')" disabled>
                                â–  åœæ­¢è¯•éªŒ
                            </button>
                            <button class="btn emergency-btn btn-lg" id="btnAbort" onclick="controlTest('abort')" disabled>
                                âš  ç´§æ€¥ä¸­æ­¢
                            </button>
                        </div>

                        <!-- Progress -->
                        <div class="overall-progress mb-2">
                            <div class="progress-label">
                                <span class="label">å‰¥ç¦»è¿›åº¦</span>
                                <span class="value" id="ctrlProgress">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="ctrlProgressBar" style="width:0%"></div>
                            </div>
                        </div>

                        <!-- Mini Stats -->
                        <div class="grid grid-2 gap-1">
                            <div class="param-card">
                                <div class="param-label">å½“å‰è§’åº¦</div>
                                <div class="param-value" id="ctrlAngle">0Â°</div>
                            </div>
                            <div class="param-card">
                                <div class="param-label">å¹³å‡å‰¥ç¦»åŠ›</div>
                                <div class="param-value" id="ctrlAvgForce">0 N</div>
                            </div>
                            <div class="param-card">
                                <div class="param-label">æœ€å¤§å‰¥ç¦»åŠ›</div>
                                <div class="param-value" id="ctrlMaxForce">0 N</div>
                            </div>
                            <div class="param-card">
                                <div class="param-label">æ´»åŠ¨æ¡å¸¦</div>
                                <div class="param-value" id="ctrlActiveStrips">0/30</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 30-Strip Monitor -->
                <div class="card animate-fade-in-up stagger-3 mb-2">
                    <div class="card-header">
                        <div class="card-title"><span class="icon">â–¦</span> 30æ¡å‰¥ç¦»åŠ›å®æ—¶ç›‘æµ‹</div>
                    </div>
                    <div class="force-gauge-grid" id="ctrlStripGrid"></div>
                </div>

                <!-- Live Chart -->
                <div class="card animate-fade-in-up stagger-4">
                    <div class="card-header">
                        <div class="card-title"><span class="icon">ã€°</span> å®æ—¶å‰¥ç¦»åŠ›æ›²çº¿</div>
                    </div>
                    <div class="chart-container" id="ctrlChart" style="min-height:350px;"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/nav.js"></script>
    <script src="/js/charts.js"></script>
    <script>
        if (!Auth.requireAuth()) throw new Error('Not authenticated');
        Nav.init();

        let activeTestId = null;
        let pollTimer = null;

        function initStripGrid() {
            const grid = document.getElementById('ctrlStripGrid');
            let html = '';
            for (let i = 1; i <= 30; i++) {
                html += `<div class="force-gauge-cell" id="ctrl-gauge-${i}">
                    <div class="gauge-label">#${i}</div>
                    <div class="gauge-value" id="ctrl-gv-${i}">0</div>
                    <div class="gauge-unit">N</div>
                </div>`;
            }
            grid.innerHTML = html;
        }
        initStripGrid();

        Charts.realtimeForceChart('ctrlChart', 30);

        async function loadProjects() {
            try {
                const res = await API.get('/projects?per_page=100');
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©é¡¹ç›®</option>';
                (res.projects || []).forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            } catch (e) {
                Utils.showToast('åŠ è½½é¡¹ç›®å¤±è´¥: ' + e.message, 'error');
            }
        }

        document.getElementById('projectSelect').addEventListener('change', async function() {
            const pid = this.value;
            const testSelect = document.getElementById('testSelect');
            if (!pid) {
                testSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®</option>';
                return;
            }
            try {
                const res = await API.get(`/tests?project_id=${pid}&per_page=100`);
                testSelect.innerHTML = '<option value="">é€‰æ‹©å·²æœ‰è¯•éªŒæˆ–åˆ›å»ºæ–°è¯•éªŒ</option>';
                (res.tests || []).forEach(t => {
                    testSelect.innerHTML += `<option value="${t.id}">${t.test_number} (${STATUS_LABELS[t.status] || t.status})</option>`;
                });
            } catch (e) {
                Utils.showToast('åŠ è½½è¯•éªŒå¤±è´¥', 'error');
            }
        });

        document.getElementById('testSelect').addEventListener('change', function() {
            activeTestId = this.value || null;
            if (activeTestId) {
                updateTestInfo();
            }
        });

        async function updateTestInfo() {
            if (!activeTestId) return;
            try {
                const res = await API.get(`/test_detail?id=${activeTestId}`);
                const test = res.test;
                document.getElementById('testNumber').value = test.test_number || '';
                document.getElementById('operator').value = test.operator || '';
                updateControlState(test.status);

                if (test.status === 'running') {
                    startPolling();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function updateControlState(status) {
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            const btnAbort = document.getElementById('btnAbort');
            const statusEl = document.getElementById('testStatus');

            if (status === 'running') {
                btnStart.disabled = true;
                btnStop.disabled = false;
                btnAbort.disabled = false;
                statusEl.className = 'badge badge-running';
                statusEl.textContent = 'è¿è¡Œä¸­';
            } else if (status === 'completed') {
                btnStart.disabled = true;
                btnStop.disabled = true;
                btnAbort.disabled = true;
                statusEl.className = 'badge badge-completed';
                statusEl.textContent = 'å·²å®Œæˆ';
            } else {
                btnStart.disabled = !activeTestId;
                btnStop.disabled = true;
                btnAbort.disabled = true;
                statusEl.className = 'badge badge-pending';
                statusEl.textContent = STATUS_LABELS[status] || 'å¾…æ‰§è¡Œ';
            }
        }

        async function createTest() {
            const pid = document.getElementById('projectSelect').value;
            if (!pid) { Utils.showToast('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'warning'); return; }

            const testNumber = document.getElementById('testNumber').value.trim();
            if (!testNumber) { Utils.showToast('è¯·è¾“å…¥è¯•éªŒç¼–å·', 'warning'); return; }

            try {
                const res = await API.post('/tests', {
                    project_id: parseInt(pid),
                    test_number: testNumber,
                    operator: document.getElementById('operator').value.trim(),
                    ambient_temp: parseFloat(document.getElementById('ambientTemp').value) || null,
                    pipe_temp: parseFloat(document.getElementById('pipeTemp').value) || null,
                    humidity: parseFloat(document.getElementById('humidity').value) || null,
                    notes: document.getElementById('testNotes').value.trim()
                });

                activeTestId = res.test.id;
                Utils.showToast('è¯•éªŒåˆ›å»ºæˆåŠŸ', 'success');
                updateControlState('pending');

                // Refresh test list
                document.getElementById('projectSelect').dispatchEvent(new Event('change'));
            } catch (e) {
                Utils.showToast('åˆ›å»ºå¤±è´¥: ' + e.message, 'error');
            }
        }

        async function controlTest(action) {
            if (!activeTestId) { Utils.showToast('è¯·å…ˆé€‰æ‹©è¯•éªŒ', 'warning'); return; }

            if (action === 'abort' && !Utils.confirm('ç¡®å®šè¦ç´§æ€¥ä¸­æ­¢è¯•éªŒå—ï¼Ÿ')) return;

            try {
                const res = await API.post('/test_start', {
                    test_id: parseInt(activeTestId),
                    action: action
                });
                Utils.showToast(res.message, 'success');
                updateControlState(res.status);

                if (action === 'start') {
                    startPolling();
                } else {
                    stopPolling();
                }
            } catch (e) {
                Utils.showToast('æ“ä½œå¤±è´¥: ' + e.message, 'error');
            }
        }

        function startPolling() {
            stopPolling();
            pollTimer = setInterval(pollData, CONFIG.POLLING_INTERVAL);
            pollData();
        }

        function stopPolling() {
            if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
        }

        async function pollData() {
            if (!activeTestId) return;
            try {
                const res = await API.get(`/realtime_poll?test_id=${activeTestId}`);
                updateControlPanel(res);
            } catch (e) {
                console.error('poll error:', e);
            }
        }

        function updateControlPanel(data) {
            if (!data) return;
            const stats = data.stats || {};
            const progress = data.progress || 0;

            document.getElementById('ctrlProgress').textContent = `${Utils.formatNumber(progress, 1)}%`;
            document.getElementById('ctrlProgressBar').style.width = `${progress}%`;
            document.getElementById('ctrlAngle').textContent = `${Utils.formatNumber(data.current_angle, 1)}Â°`;
            document.getElementById('ctrlAvgForce').textContent = `${Utils.formatNumber(stats.avg_force, 1)} N`;
            document.getElementById('ctrlMaxForce').textContent = `${Utils.formatNumber(stats.max_force, 1)} N`;
            document.getElementById('ctrlActiveStrips').textContent = `${stats.active_strips || 0}/30`;

            if (data.latest_data) {
                data.latest_data.forEach(d => {
                    const f = parseFloat(d.force_value);
                    const valEl = document.getElementById(`ctrl-gv-${d.strip_number}`);
                    const cell = document.getElementById(`ctrl-gauge-${d.strip_number}`);
                    if (valEl) valEl.textContent = f.toFixed(0);
                    if (cell) {
                        cell.className = 'force-gauge-cell' + (f > 0 ? ' active' : '');
                    }
                });
            }

            if (data.recent_history && data.recent_history.length > 0) {
                const byStrip = {};
                const angles = new Set();
                data.recent_history.forEach(d => {
                    const sn = d.strip_number;
                    if (!byStrip[sn]) byStrip[sn] = [];
                    const angle = parseFloat(d.position_angle).toFixed(1);
                    byStrip[sn].push({ angle, force: parseFloat(d.force_value) });
                    angles.add(angle);
                });
                const sortedAngles = [...angles].sort((a, b) => parseFloat(a) - parseFloat(b));
                const series = [];
                for (let i = 1; i <= 30; i++) {
                    series.push({
                        name: `æ¡å¸¦${i}`,
                        type: 'line',
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { width: 1.5 },
                        data: (byStrip[i] || []).map(p => p.force)
                    });
                }
                Charts.update('ctrlChart', { xAxis: { data: sortedAngles }, series });
            }

            if (!data.is_running && data.test && data.test.status !== 'running') {
                updateControlState(data.test.status);
                stopPolling();
            }
        }

        loadProjects();

        // Check for already running test
        (async () => {
            try {
                const res = await API.get('/tests?status=running&per_page=1');
                if (res.tests && res.tests.length > 0) {
                    activeTestId = res.tests[0].id;
                    updateControlState('running');
                    startPolling();
                    Utils.showToast('æ£€æµ‹åˆ°æ­£åœ¨è¿è¡Œçš„è¯•éªŒ', 'info');
                }
            } catch (e) {}
        })();
    </script>
</body>
</html>
