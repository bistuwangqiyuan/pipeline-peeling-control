<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯•éªŒæŠ¥å‘Š - ç®¡é“é˜²è…å±‚å‰¥ç¦»æ§åˆ¶ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/animations.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        @media print {
            .sidebar, .page-header, .no-print { display: none !important; }
            .main-content { margin-left: 0 !important; }
            .page-body { padding: 0 !important; }
            body { background: white; color: #333; }
            .card { border: 1px solid #ddd; background: white; }
            .stat-card { background: #f9f9f9; border: 1px solid #ddd; }
            .stat-card .stat-value { color: #333; text-shadow: none; }
            .stat-card .stat-label { color: #666; }
            .report-header { background: white !important; border: none !important; }
            .report-header h2 { color: #333 !important; text-shadow: none !important; }
            .data-table th { background: #f0f0f0; color: #333; }
            .data-table td { color: #333; border-color: #ddd; }
        }
        .report-header {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .report-header h2 {
            font-size: 1.5rem;
            color: var(--accent-cyan);
            text-shadow: var(--text-glow-cyan);
            margin-bottom: 0.5rem;
        }
        .report-header .report-meta {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .report-section {
            margin-bottom: 1.5rem;
        }
        .report-section h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <div class="page-header no-print">
                <h1>ğŸ“‹ è¯•éªŒæŠ¥å‘Š</h1>
                <div class="header-actions">
                    <select class="form-select" id="projectFilter" style="width:200px;" onchange="loadTests()">
                        <option value="">é€‰æ‹©é¡¹ç›®</option>
                    </select>
                    <select class="form-select" id="testFilter" style="width:200px;" onchange="generateReport()">
                        <option value="">é€‰æ‹©è¯•éªŒ</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="window.print()">ğŸ–¨ æ‰“å°æŠ¥å‘Š</button>
                    <button class="btn btn-secondary btn-sm" onclick="exportCSV()">å¯¼å‡ºCSV</button>
                </div>
            </div>
            <div class="page-body">
                <div id="noData" class="card animate-fade-in">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“‹</div>
                        <p>è¯·é€‰æ‹©å·²å®Œæˆçš„è¯•éªŒä»¥ç”ŸæˆæŠ¥å‘Š</p>
                    </div>
                </div>

                <div id="reportContent" style="display:none;">
                    <div class="report-header">
                        <h2>ç®¡é“é˜²è…å±‚å‰¥ç¦»è¯•éªŒæŠ¥å‘Š</h2>
                        <div class="report-meta" id="reportMeta"></div>
                    </div>

                    <div class="report-section">
                        <h3>ä¸€ã€è¯•éªŒåŸºæœ¬ä¿¡æ¯</h3>
                        <div class="grid grid-3 mb-2">
                            <div class="param-card"><div class="param-label">è¯•éªŒç¼–å·</div><div class="param-value" id="rTestNum">-</div></div>
                            <div class="param-card"><div class="param-label">é¡¹ç›®åç§°</div><div class="param-value" id="rProject">-</div></div>
                            <div class="param-card"><div class="param-label">æ“ä½œå‘˜</div><div class="param-value" id="rOperator">-</div></div>
                            <div class="param-card"><div class="param-label">å¼€å§‹æ—¶é—´</div><div class="param-value" id="rStart" style="font-size:0.85rem;">-</div></div>
                            <div class="param-card"><div class="param-label">ç»“æŸæ—¶é—´</div><div class="param-value" id="rEnd" style="font-size:0.85rem;">-</div></div>
                            <div class="param-card"><div class="param-label">è¯•éªŒçŠ¶æ€</div><div class="param-value" id="rStatus">-</div></div>
                        </div>
                        <div class="grid grid-3">
                            <div class="param-card"><div class="param-label">ç¯å¢ƒæ¸©åº¦</div><div class="param-value" id="rAmbTemp">-</div></div>
                            <div class="param-card"><div class="param-label">ç®¡é“æ¸©åº¦</div><div class="param-value" id="rPipeTemp">-</div></div>
                            <div class="param-card"><div class="param-label">æ¹¿åº¦</div><div class="param-value" id="rHumidity">-</div></div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>äºŒã€æ€»ä½“ç»Ÿè®¡ç»“æœ</h3>
                        <div class="grid grid-4 mb-2">
                            <div class="stat-card accent-cyan"><div class="stat-label">å¹³å‡å‰¥ç¦»åŠ›</div><div class="stat-value" id="rAvg">-<span class="stat-unit"> N</span></div></div>
                            <div class="stat-card accent-blue"><div class="stat-label">æœ€å¤§å‰¥ç¦»åŠ›</div><div class="stat-value" id="rMax">-<span class="stat-unit"> N</span></div></div>
                            <div class="stat-card accent-success"><div class="stat-label">æœ€å°å‰¥ç¦»åŠ›</div><div class="stat-value" id="rMin">-<span class="stat-unit"> N</span></div></div>
                            <div class="stat-card accent-warning"><div class="stat-label">æ ‡å‡†å·®</div><div class="stat-value" id="rStd">-<span class="stat-unit"> N</span></div></div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>ä¸‰ã€å‰¥ç¦»åŠ›-è§’åº¦æ›²çº¿</h3>
                        <div class="card"><div class="chart-container" id="rChartAngle" style="min-height:400px;"></div></div>
                    </div>

                    <div class="report-section">
                        <h3>å››ã€å„æ¡å¸¦å‰¥ç¦»åŠ›å¯¹æ¯”</h3>
                        <div class="card"><div class="chart-container" id="rChartBar" style="min-height:350px;"></div></div>
                    </div>

                    <div class="report-section">
                        <h3>äº”ã€å„æ¡å¸¦ç»Ÿè®¡æ•°æ®</h3>
                        <div class="card" style="overflow-x:auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>æ¡å¸¦ç¼–å·</th>
                                        <th>å¹³å‡åŠ› (N)</th>
                                        <th>æœ€å¤§åŠ› (N)</th>
                                        <th>æœ€å°åŠ› (N)</th>
                                        <th>æ ‡å‡†å·® (N)</th>
                                        <th>æ€»ä½ç§» (mm)</th>
                                        <th>ç»“è®º</th>
                                    </tr>
                                </thead>
                                <tbody id="rTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3>å…­ã€ç»“è®º</h3>
                        <div class="card p-2" id="rConclusion" style="font-size:0.9rem;line-height:1.8;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/nav.js"></script>
    <script src="/js/charts.js"></script>
    <script>
        if (!Auth.requireAuth()) throw new Error('Not authenticated');
        Nav.init();

        async function loadProjects() {
            try {
                const res = await API.get('/projects?per_page=100');
                const select = document.getElementById('projectFilter');
                select.innerHTML = '<option value="">é€‰æ‹©é¡¹ç›®</option>';
                (res.projects || []).forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            } catch (e) {}
        }

        async function loadTests() {
            const pid = document.getElementById('projectFilter').value;
            const select = document.getElementById('testFilter');
            select.innerHTML = '<option value="">é€‰æ‹©è¯•éªŒ</option>';
            if (!pid) return;
            try {
                const res = await API.get(`/tests?project_id=${pid}&per_page=100`);
                (res.tests || []).forEach(t => {
                    select.innerHTML += `<option value="${t.id}">${t.test_number} (${STATUS_LABELS[t.status] || t.status})</option>`;
                });
            } catch (e) {}
        }

        async function generateReport() {
            const testId = document.getElementById('testFilter').value;
            if (!testId) {
                document.getElementById('noData').style.display = '';
                document.getElementById('reportContent').style.display = 'none';
                return;
            }

            try {
                const res = await API.get(`/data?action=analysis&test_id=${testId}`);
                document.getElementById('noData').style.display = 'none';
                document.getElementById('reportContent').style.display = '';
                renderReport(res);
            } catch (e) {
                Utils.showToast('ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ' + e.message, 'error');
            }
        }

        function renderReport(data) {
            const test = data.test || {};
            const os = data.overall_stats || {};
            const stats = data.strip_stats || [];

            document.getElementById('reportMeta').textContent =
                `é¡¹ç›®: ${test.project_name || '-'} | è¯•éªŒç¼–å·: ${test.test_number || '-'} | ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;

            document.getElementById('rTestNum').textContent = test.test_number || '-';
            document.getElementById('rProject').textContent = test.project_name || '-';
            document.getElementById('rOperator').textContent = test.operator || '-';
            document.getElementById('rStart').textContent = Utils.formatDate(test.start_time);
            document.getElementById('rEnd').textContent = Utils.formatDate(test.end_time);
            document.getElementById('rStatus').textContent = STATUS_LABELS[test.status] || test.status;
            document.getElementById('rAmbTemp').textContent = test.ambient_temp ? `${test.ambient_temp}Â°C` : '-';
            document.getElementById('rPipeTemp').textContent = test.pipe_temp ? `${test.pipe_temp}Â°C` : '-';
            document.getElementById('rHumidity').textContent = test.humidity ? `${test.humidity}%` : '-';

            document.getElementById('rAvg').innerHTML = `${Utils.formatNumber(os.overall_avg, 1)}<span class="stat-unit"> N</span>`;
            document.getElementById('rMax').innerHTML = `${Utils.formatNumber(os.overall_max, 1)}<span class="stat-unit"> N</span>`;
            document.getElementById('rMin').innerHTML = `${Utils.formatNumber(os.overall_min, 1)}<span class="stat-unit"> N</span>`;
            document.getElementById('rStd').innerHTML = `${Utils.formatNumber(os.overall_std, 1)}<span class="stat-unit"> N</span>`;

            if (data.force_vs_angle && data.force_vs_angle.length > 0) {
                Charts.forceVsAngleChart('rChartAngle', data.force_vs_angle);
            }

            if (stats.length > 0) {
                Charts.forceBarChart('rChartBar',
                    stats.map(s => `#${s.strip_number}`),
                    stats.map(s => parseFloat(s.avg_force))
                );
            }

            const tbody = document.getElementById('rTableBody');
            tbody.innerHTML = stats.map(s => {
                const pass = parseFloat(s.avg_force) > CONFIG.FORCE_ALARM_LOW;
                return `<tr>
                    <td class="text-mono font-bold">#${s.strip_number}</td>
                    <td class="text-mono">${Utils.formatNumber(s.avg_force, 2)}</td>
                    <td class="text-mono">${Utils.formatNumber(s.max_force, 2)}</td>
                    <td class="text-mono">${Utils.formatNumber(s.min_force, 2)}</td>
                    <td class="text-mono">${Utils.formatNumber(s.std_force, 2)}</td>
                    <td class="text-mono">${Utils.formatNumber(s.total_displacement, 2)}</td>
                    <td><span class="badge ${pass ? 'badge-completed' : 'badge-aborted'}">${pass ? 'åˆæ ¼' : 'ä¸åˆæ ¼'}</span></td>
                </tr>`;
            }).join('');

            const passCount = stats.filter(s => parseFloat(s.avg_force) > CONFIG.FORCE_ALARM_LOW).length;
            const rate = stats.length > 0 ? (passCount / stats.length * 100).toFixed(1) : 0;
            document.getElementById('rConclusion').innerHTML = `
                <p>æœ¬æ¬¡å‰¥ç¦»è¯•éªŒå…±æµ‹è¯• <strong>${stats.length}</strong> æ¡é˜²è…å±‚æ¡å¸¦ï¼Œç®¡é“åœ†å‘¨å‰¥ç¦»è§’åº¦è¦†ç›– 360Â°ã€‚</p>
                <p>æ•´ä½“å¹³å‡å‰¥ç¦»åŠ›ä¸º <strong class="text-cyan">${Utils.formatNumber(os.overall_avg, 1)} N</strong>ï¼Œ
                   æœ€å¤§å‰¥ç¦»åŠ›ä¸º <strong>${Utils.formatNumber(os.overall_max, 1)} N</strong>ï¼Œ
                   æ ‡å‡†å·®ä¸º <strong>${Utils.formatNumber(os.overall_std, 1)} N</strong>ã€‚</p>
                <p>åˆæ ¼æ¡å¸¦æ•°: <strong class="text-success">${passCount}</strong> / ${stats.length}ï¼Œ
                   åˆæ ¼ç‡: <strong class="text-cyan">${rate}%</strong>ã€‚</p>
                <p>æ•°æ®è®°å½•æ€»ç‚¹æ•°: <strong>${os.total_points}</strong>ã€‚</p>
            `;
        }

        function exportCSV() {
            const testId = document.getElementById('testFilter').value;
            if (!testId) return;
            window.open(`/api/data?action=export&test_id=${testId}`, '_blank');
        }

        loadProjects();
    </script>
</body>
</html>
