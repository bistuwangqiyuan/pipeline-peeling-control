<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - ç®¡é“é˜²è…å±‚å‰¥ç¦»æ§åˆ¶ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/animations.css">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <div class="page-header">
                <h1>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h1>
            </div>
            <div class="page-body">
                <div class="card animate-fade-in">
                    <div style="overflow-x:auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ç”¨æˆ·å</th>
                                    <th>æ‰‹æœºå·</th>
                                    <th>è§’è‰²</th>
                                    <th>æˆæƒç </th>
                                    <th>çŠ¶æ€</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="usersBody">
                                <tr><td colspan="8" class="text-center text-dim p-3">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ç¼–è¾‘ç”¨æˆ·</h3>
                <button class="modal-close" onclick="Utils.hideModal('userModal')">âœ•</button>
            </div>
            <form id="userForm" onsubmit="return saveUser(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-input" id="euUsername" disabled>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">è§’è‰²</label>
                        <select class="form-select" id="euRole">
                            <option value="admin">ç®¡ç†å‘˜</option>
                            <option value="user">æ™®é€šç”¨æˆ·</option>
                            <option value="test">æµ‹è¯•ç”¨æˆ·</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">çŠ¶æ€</label>
                        <select class="form-select" id="euActive">
                            <option value="true">å¯ç”¨</option>
                            <option value="false">ç¦ç”¨</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ‰‹æœºå·</label>
                    <input type="text" class="form-input" id="euPhone" placeholder="é€‰å¡«">
                </div>
                <div class="form-group">
                    <label class="form-label">æˆæƒç </label>
                    <input type="text" class="form-input" id="euAuthCode" placeholder="é€‰å¡«">
                </div>
                <div class="form-group">
                    <label class="form-label">é‡ç½®å¯†ç </label>
                    <input type="password" class="form-input" id="euPassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="Utils.hideModal('userModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/nav.js"></script>
    <script>
        if (!Auth.requireAuth()) throw new Error('Not authenticated');
        if (!Auth.requireAdmin()) {
            window.location.href = PAGES.DASHBOARD;
            throw new Error('Not admin');
        }
        Nav.init();

        async function loadUsers() {
            try {
                const res = await API.get('/admin_users?per_page=100');
                renderUsers(res.users || []);
            } catch (e) {
                Utils.showToast('åŠ è½½ç”¨æˆ·å¤±è´¥: ' + e.message, 'error');
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersBody');
            tbody.innerHTML = users.map(u => `
                <tr class="animate-fade-in">
                    <td class="text-mono">${u.id}</td>
                    <td><strong>${Utils.escapeHtml(u.username)}</strong></td>
                    <td>${u.phone || '-'}</td>
                    <td>${Utils.roleBadge(u.role)}</td>
                    <td class="text-mono text-dim">${u.auth_code || '-'}</td>
                    <td><span class="badge ${u.is_active ? 'badge-completed' : 'badge-aborted'}">${u.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                    <td class="text-dim">${Utils.formatDateShort(u.created_at)}</td>
                    <td>
                        <button class="btn btn-ghost btn-sm" onclick="editUser(${u.id}, '${Utils.escapeHtml(u.username)}', '${u.role}', ${u.is_active}, '${u.phone || ''}', '${u.auth_code || ''}')">ç¼–è¾‘</button>
                        <button class="btn btn-ghost btn-sm text-danger" onclick="deleteUser(${u.id}, '${Utils.escapeHtml(u.username)}')">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function editUser(id, username, role, active, phone, authCode) {
            document.getElementById('editUserId').value = id;
            document.getElementById('euUsername').value = username;
            document.getElementById('euRole').value = role;
            document.getElementById('euActive').value = String(active);
            document.getElementById('euPhone').value = phone;
            document.getElementById('euAuthCode').value = authCode;
            document.getElementById('euPassword').value = '';
            Utils.showModal('userModal');
        }

        async function saveUser(e) {
            e.preventDefault();
            const id = document.getElementById('editUserId').value;
            const data = {
                role: document.getElementById('euRole').value,
                is_active: document.getElementById('euActive').value === 'true',
                phone: document.getElementById('euPhone').value.trim(),
                auth_code: document.getElementById('euAuthCode').value.trim()
            };
            const pw = document.getElementById('euPassword').value;
            if (pw) data.password = pw;

            try {
                await API.put(`/admin_users?id=${id}`, data);
                Utils.showToast('ç”¨æˆ·å·²æ›´æ–°', 'success');
                Utils.hideModal('userModal');
                loadUsers();
            } catch (e) {
                Utils.showToast('æ›´æ–°å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function deleteUser(id, username) {
            if (!Utils.confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿ`)) return;
            try {
                await API.delete(`/admin_users?id=${id}`);
                Utils.showToast('ç”¨æˆ·å·²åˆ é™¤', 'success');
                loadUsers();
            } catch (e) {
                Utils.showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }

        loadUsers();
    </script>
</body>
</html>
