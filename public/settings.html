<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè®¾ç½® - ç®¡é“é˜²è…å±‚å‰¥ç¦»æ§åˆ¶ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/animations.css">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <div class="page-header">
                <h1>âš™ ç³»ç»Ÿè®¾ç½®</h1>
            </div>
            <div class="page-body">
                <div class="grid grid-2 mb-2">
                    <!-- Settings -->
                    <div class="card animate-fade-in-up">
                        <div class="card-header">
                            <div class="card-title"><span class="icon">âš™</span> ç³»ç»Ÿå‚æ•°</div>
                        </div>
                        <div id="settingsForm">
                            <p class="text-dim">åŠ è½½ä¸­...</p>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>

                    <!-- System Info -->
                    <div class="card animate-fade-in-up stagger-2">
                        <div class="card-header">
                            <div class="card-title"><span class="icon">â„¹</span> ç³»ç»Ÿä¿¡æ¯</div>
                        </div>
                        <div class="param-card mb-1">
                            <div class="param-label">ç³»ç»Ÿç‰ˆæœ¬</div>
                            <div class="param-value" style="font-size:0.9rem;">v1.0.0</div>
                        </div>
                        <div class="param-card mb-1">
                            <div class="param-label">éƒ¨ç½²å¹³å°</div>
                            <div class="param-value" style="font-size:0.9rem;">Vercel + Neon PostgreSQL</div>
                        </div>
                        <div class="param-card mb-1">
                            <div class="param-label">æŠ€æœ¯æ ˆ</div>
                            <div class="param-value" style="font-size:0.9rem;">Python + HTML/CSS/JS + ECharts</div>
                        </div>
                        <div class="param-card">
                            <div class="param-label">æ•°æ®åº“çŠ¶æ€</div>
                            <div class="param-value" style="font-size:0.9rem;" id="dbStatus">æ£€æµ‹ä¸­...</div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-secondary btn-sm" onclick="initDB()">é‡æ–°åˆå§‹åŒ–æ•°æ®åº“</button>
                        </div>
                    </div>
                </div>

                <!-- Audit Log -->
                <div class="card animate-fade-in-up stagger-3">
                    <div class="card-header">
                        <div class="card-title"><span class="icon">ğŸ“œ</span> å®¡è®¡æ—¥å¿—</div>
                        <div class="flex gap-1">
                            <select class="form-select" id="auditFilter" style="width:150px;" onchange="loadAuditLog()">
                                <option value="">å…¨éƒ¨æ“ä½œ</option>
                                <option value="login">ç™»å½•</option>
                                <option value="register">æ³¨å†Œ</option>
                                <option value="create">åˆ›å»º</option>
                                <option value="update">æ›´æ–°</option>
                                <option value="delete">åˆ é™¤</option>
                                <option value="start_test">å¯åŠ¨è¯•éªŒ</option>
                                <option value="stop_test">åœæ­¢è¯•éªŒ</option>
                            </select>
                        </div>
                    </div>
                    <div style="overflow-x:auto; max-height:400px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>ç”¨æˆ·</th>
                                    <th>æ“ä½œ</th>
                                    <th>èµ„æºç±»å‹</th>
                                    <th>èµ„æºID</th>
                                    <th>è¯¦æƒ…</th>
                                </tr>
                            </thead>
                            <tbody id="auditBody">
                                <tr><td colspan="6" class="text-center text-dim p-3">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="auditPagination"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/nav.js"></script>
    <script>
        if (!Auth.requireAuth()) throw new Error('Not authenticated');
        Nav.init();

        let settingsData = {};
        let auditPage = 1;

        async function loadSettings() {
            try {
                const res = await API.get('/settings');
                const settings = res.settings || [];
                settingsData = res.settings_map || {};
                renderSettings(settings);
                document.getElementById('dbStatus').textContent = 'å·²è¿æ¥';
                document.getElementById('dbStatus').style.color = 'var(--success)';
            } catch (e) {
                document.getElementById('dbStatus').textContent = 'è¿æ¥å¤±è´¥';
                document.getElementById('dbStatus').style.color = 'var(--danger)';
            }
        }

        function renderSettings(settings) {
            const container = document.getElementById('settingsForm');
            container.innerHTML = settings.map(s => `
                <div class="form-group">
                    <label class="form-label">${Utils.escapeHtml(s.description || s.setting_key)}</label>
                    <input type="text" class="form-input setting-input"
                           data-key="${s.setting_key}"
                           value="${Utils.escapeHtml(s.setting_value || '')}">
                </div>
            `).join('');
        }

        async function saveSettings() {
            const inputs = document.querySelectorAll('.setting-input');
            const updates = {};
            inputs.forEach(input => {
                updates[input.dataset.key] = input.value;
            });

            try {
                await API.put('/settings', { settings: updates });
                Utils.showToast('è®¾ç½®å·²ä¿å­˜', 'success');
            } catch (e) {
                Utils.showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function loadAuditLog() {
            const action = document.getElementById('auditFilter').value;
            try {
                let url = `/admin?action=audit&page=${auditPage}&per_page=30`;
                if (action) url += `&action_filter=${action}`;
                const res = await API.get(url);
                renderAuditLog(res.logs || [], res.total, res.page, res.per_page);
            } catch (e) {
                document.getElementById('auditBody').innerHTML =
                    '<tr><td colspan="6" class="text-center text-dim">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        function renderAuditLog(logs, total, page, perPage) {
            const tbody = document.getElementById('auditBody');
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-dim p-3">æš‚æ— æ—¥å¿—</td></tr>';
                return;
            }
            tbody.innerHTML = logs.map(l => `
                <tr>
                    <td class="text-dim text-mono" style="font-size:0.75rem;">${Utils.formatDate(l.created_at)}</td>
                    <td>${Utils.escapeHtml(l.username || '-')}</td>
                    <td><span class="badge badge-user">${l.action}</span></td>
                    <td>${l.resource_type || '-'}</td>
                    <td class="text-mono">${l.resource_id || '-'}</td>
                    <td class="text-dim" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${l.details ? JSON.stringify(l.details).substring(0, 50) : '-'}</td>
                </tr>
            `).join('');

            const pages = Math.ceil(total / perPage);
            const container = document.getElementById('auditPagination');
            if (pages <= 1) { container.innerHTML = ''; return; }
            let html = '';
            for (let i = 1; i <= Math.min(pages, 10); i++) {
                html += `<button class="${i === page ? 'active' : ''}" onclick="auditPage=${i};loadAuditLog()">${i}</button>`;
            }
            container.innerHTML = html;
        }

        async function initDB() {
            if (!Utils.confirm('ç¡®å®šè¦é‡æ–°åˆå§‹åŒ–æ•°æ®åº“å—ï¼Ÿï¼ˆå·²æœ‰æ•°æ®ä¸ä¼šä¸¢å¤±ï¼‰')) return;
            try {
                const res = await API.get('/init_db');
                Utils.showToast(res.message, 'success');
            } catch (e) {
                Utils.showToast('åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
            }
        }

        loadSettings();
        loadAuditLog();
    </script>
</body>
</html>
